C51 COMPILER V9.54   MAIN                                                                  12/29/2024 12:00:17 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\快充诱骗管理芯片) DEBUG OBJECTEX
                    -TEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include        "config.h"
   2          #include        "STC8G_H_GPIO.h"
   3          #include        "STC8G_H_Delay.h"
   4          #include    "STC8G_H_EEPROM.h"
   5          
   6          //掉电存储 0关闭 1开启
   7          #define POWER_DOWN_STORAGE 1
   8          //按钮持续时间，即按下多少ms再松开才判断按钮按下
   9          #define BUTTON_TIME 100
  10          
  11          u8 mode[2]={0,0};
  12          int timecnt=0;
  13          void GPIO_Init(void)
  14          {
  15   1              GPIO_InitTypeDef GPIO_InitStructure;
  16   1              GPIO_InitStructure.Pin  = GPIO_Pin_3;
  17   1              GPIO_InitStructure.Mode = GPIO_OUT_PP;
  18   1              GPIO_Inilize(GPIO_P3,&GPIO_InitStructure);
  19   1              GPIO_InitStructure.Pin  = GPIO_Pin_4|GPIO_Pin_5;
  20   1              GPIO_InitStructure.Mode = GPIO_OUT_PP;
  21   1              GPIO_Inilize(GPIO_P5,&GPIO_InitStructure);
  22   1              
  23   1              GPIO_InitStructure.Pin  = GPIO_Pin_2;
  24   1              GPIO_InitStructure.Mode = GPIO_PullUp;
  25   1              GPIO_Inilize(GPIO_P3,&GPIO_InitStructure);
  26   1              //默认请求电压5V
  27   1              P54=1;//CFG1
  28   1              P55=0;//CFG2
  29   1              P33=0;//CFG3
  30   1      }
  31          //请求电压模式
  32          //0-5V 1-9V 2-12V 3-15V 4-20V
  33          void RequestVoltageMode(u8 mode)
  34          {
  35   1              if(mode<0||mode>4)mode=0;
  36   1              switch(mode){
  37   2                      case 0:
  38   2                              P54=1;//CFG1
  39   2                              P55=0;//CFG2
  40   2                              P33=0;//CFG3
  41   2                              break;
  42   2                      case 1:
  43   2                              P54=0;//CFG1
  44   2                              P55=0;//CFG2
  45   2                              P33=0;//CFG3
  46   2                              break;
  47   2                      case 2:
  48   2                              P54=0;//CFG1
  49   2                              P55=0;//CFG2
  50   2                              P33=1;//CFG3
  51   2                              break;
  52   2                      case 3:
  53   2                              P54=0;//CFG1
  54   2                              P55=1;//CFG2
C51 COMPILER V9.54   MAIN                                                                  12/29/2024 12:00:17 PAGE 2   

  55   2                              P33=1;//CFG3
  56   2                              break;
  57   2                      case 4:
  58   2                              P54=0;//CFG1
  59   2                              P55=1;//CFG2
  60   2                              P33=0;//CFG3
  61   2                              break;
  62   2              }
  63   1      }
  64          void main(void)
  65          {
  66   1              GPIO_Init();
  67   1      #if POWER_DOWN_STORAGE
  68   1              EEPROM_read_n(0,mode,1);
  69   1              if(mode[0]<0||mode[0]>4){
  70   2                      mode[0]=0;
  71   2                      mode[1]=mode[0];
  72   2                      RequestVoltageMode(mode[0]);
  73   2                      EEPROM_SectorErase(0);
  74   2                      EEPROM_write_n(0,mode,1);
  75   2              }else{
  76   2                      RequestVoltageMode(mode[0]);
  77   2                      mode[1]=mode[0];
  78   2              }
  79   1      #else
                      mode[0]=0;
                      RequestVoltageMode(mode[0]);
                      mode[1]=mode[0];
              #endif
  84   1              
  85   1              while(1)
  86   1              {
  87   2                      while(!P32){
  88   3                              timecnt++;
  89   3                              delay_ms(1);
  90   3                      }
  91   2                      if(timecnt>BUTTON_TIME){
  92   3                              if(mode[0]<4)mode[0]++;
  93   3                              else mode[0]=0;
  94   3                      }
  95   2                      timecnt=0;
  96   2                      if(mode[1]!=mode[0]){
  97   3                              if(mode[0]<0||mode[0]>4)mode[0]=0;
  98   3                              RequestVoltageMode(mode[0]);
  99   3                              mode[1]=mode[0];
 100   3      #if POWER_DOWN_STORAGE
 101   3                              EEPROM_SectorErase(0);
 102   3                              EEPROM_write_n(0,mode,1);
 103   3      #endif
 104   3                      }
 105   2              }
 106   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    306    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.54   MAIN                                                                  12/29/2024 12:00:17 PAGE 3   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
